#!/bin/bash

# Usage:
#	radio [RADIO]
# 	radio list

CONFIG=$HOME/.radio

if [ ! -e $CONFIG ]; then
	echo "Create a config at $CONFIG"
	exit 2
fi


function list_radios() {
	grep -v "^#\|^$" $CONFIG | awk -F ':' '{print $1}' | sort
}

function find_radio_url() {
	url=$(grep -v "^#" $CONFIG | grep $1 | cut -d ':' -f 2- | tr -d '\t ')
	echo $url
}

function play_radio_mpc() {
	echo "Playing $1"
	url=$(find_radio_url $1)
	if [ "$url" == "" ]; then
		echo "No URL found"
		exit 1
	fi
	mpc clear
	if [[ $url == *.pls* ]]; then
		mpc load "$url"
	else
		mpc add "$url"
	fi
	mpc play
}

function play_radio_mplayer() {
	echo "Playing $1"
	url=$(find_radio_url $1)
	mplayer -cache-min 0 -playlist "$url"
}

function has_mplayer() {
	which mplayer > /dev/null
	return $?
}

# Figure out best method of playing and use it
# Logic: if MPD_HOST is set, use 'mpc'
#        otherwise use mplayer if it exists,
#        otherwise try mpc (last ditch attempt)
function play_best() {
	if [ "$MPD_HOST" != "" ]; then
		play_radio_mpc $1
	elif has_mplayer; then
		play_radio_mplayer $1
	else
		play_radio_mpc $1
	fi
}

if [ "$1" == "list" ] || [ "$1" == "" ]; then
	list_radios
elif [ "$1" == "stop" ]; then
	mpc stop
else
	play_best $1
fi
